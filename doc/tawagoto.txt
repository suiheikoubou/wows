Supporting only Japanese
encoding UTF-8
tab4

水兵工房 WoWS

〇まえおき
現役時代からも言ってましたし、stats&numberさんも警告出してる通りですが、
WGDevは全くやる気がないので、新規のコンテンツ分が反映されることもないでしょう。
それでもまだWGを見捨てていないかた向けに、一部のプログラムソースを公開します。


〇対象
プログラム経験がそこそこあって、WGAPIを少し触ったことがある人を対象にしています。
見よう見まねでコンパイルだけ通して実行するのは推奨しません。


〇公開範囲
（とりあえずひとに見せられるように書きなおしたところまで）
アカウント・船別戦績を処理しやすい形に成型するところまでになります。
それ以降はご自分で組んでください。


〇外部ライブラリ
JSONの解析に、Hidekatsu Izuno様の JSONIC を使用しています。
https://github.com/hidekatsu-izuno/jsonic
感謝！


〇使用方法
基本的には、「smpl_asia.txt」を見ると大体読めてくるとは思います。
が、そのまま実行すると悲劇が起きるので少しだけ解説を。

大体の流れは、
アカウント一覧ダウンロード(JSON)		15～30時間
↓
アカウント一覧抽出(JSON→TXT) 			15分
↓
アクティブID抽出						 5分
↓
船別戦績ダウンロード(JSON) 				30～60時間（期間によりさらに増える）
↓
船別戦績抽出(JSON→TXT) 				15分
↓
船別戦績マージ（前回まで＋今回差分）	15分
↓
非公開ID抽出（差分処理ではじくため）	 5分
↓
期間差分抽出							15分


〇補足等
・メモリ
	扱うデータ量が多い＆読込部→処理部→出力部という構成にしてるのである程度データを持つことになる
	とにかくメモリ食います
	16GBじゃきついと思います

・なぜデータベースを使わないか
	最初は使っていましたが、圧倒的大量データのため単純JOINですら負荷が膨大になり、
	初年度ですでに、期間差分抽出する部分だけで40時間以上かかるようになってしまった。
	結合はaccountIdとshipIdくらいなので、対象を小分け（1000分割）して結合処理の負荷を減らす作りになった。

・ダウンロードの時間
	WGAPIは、「１グローバルIPにつき10リクエスト／秒」の制限がかかっている。
	無駄にアカウント数が多い（アジアでも現在480万）ので、例えば1ID／リクエストの船別戦績を全件抽出しようとすると、
	最速でとっても単純計算で48万秒≒133時間かかる計算になる。（EUならその倍）

	ただ、定着率が悪いことに定評があるので、一定の期間内でアクティブだったアカウントのみ抽出し、
	前回データ（まあ初回は全件とるしかないかもだが）とマージすることで、ダウンロード量を減らしている。

	最速でダウンロードするために、サイクル10秒のスレッドを100個並列で配置し0.1秒ずらしで実行している。
	（１リクエスト5秒くらいかかることもあるため）

・アカウント一覧のとりかた
	ID空間はある程度法則があり、開始値を基準にある程度前詰めされて配置されている。（無法地帯のRUは見ない）
	EU		 500000000	～	 602243782	（現在）
	NA		1000000000	～	1053947433	（現在）
	ASIA	2000000000	～	2043227837	（現在）
	(KR)	3000000000	～	3001669366	（現在）
	なので理論上この範囲を総当たりすれば、ID一覧を作れる。
	アカウント情報は100ID／リクエストなので、1～2日くらいで抽出できる。
	リージョン変更したアカウントはたぶん漏れるが、どうしようもないので非公開だと思うしかない。
	
	なお、名前検索から枝を追ってく方法もあるにはあるが、
	削除されたアカウントがあると検索が止まるとかよくわからない仕様があり、
	さらにこちらのほうが時間がかかるから、今の方法に行きついてます。

・なぜダウンロードと同時に解析しないのか
	APIがよくミスるからです。
	数十時間単位の処理をずっと見ておくことはできないから放置することになるが、
	そろそろ終わったと思ってふたを開けて止まってるのが嫌なので、
	後でまとめて解析したほうが精神衛生上よろしいです。

・ArtAgro（砲弾潜在ダメージ）
	APIで取得できる値は32bit整数なので、約21億を超える値は取得できません。
	同じ船に1000戦くらい乗ってると砲弾潜在ダメージは上限に達するので、あてになりません。



〇免責
自己責任


